<!DOCTYPE html>
<html lang="en">

<head>
  <title>Azure Communication Services Quickstart</title>
  <style>
    table {
      width: 100vw;
      table-layout: fixed;
      align-content: center;
    }
    th, td {
      vertical-align: top;
      padding: 10px;
      text-align: center;
    }
  </style>
</head>

<body>
  <h2 style="text-align: center;">Multiple Dial Out Sample</h2>
  <form>
    <table>
      <tr>
        <th style="width: 50vw;">Call Connections</th>
        <th style="width: 50vw;">Call Details</th>
      </tr>
      <tr>
        <td>    
          <div>
            <div style="font-weight: bold;">STEP 0. Assign Environment Variables</div>
            <div>Configure environment variables in the .env file</div>
          </div>
          <p>
            <div style="font-weight: bold;">STEP 1. Configure Webhook</div>
            <div>Configure Event Grid webhook to point to /api/MoveParticipantEvent endpoint</div>
          </p>
          <p>
            <div style="font-weight: bold;">STEP 2. Make a Call</div>
            <div>Make a call from User Phone Number to ACS Inbound Phone Number by clicking on this button</div>
            <input type="submit" formaction="/userCallToCallAutomation" value="User Call To Call Automation!">
          </p>
          <p>
            <div style="font-weight: bold;">STEP 3a. Create Call 2</div>
            <div>Create a Call for ACS Test Identity 2 by clicking on this button and answer it manually from Web Client App</div>
            <input type="submit" formaction="/createCall2" value="Create Call 2!">
          </p>
          <p>
            <div style="font-weight: bold;">STEP 3b. Create Call 3</div>
            <div>Create a Call for ACS Test Identity 3 by clicking on this button and answer it manually from Web Client App</div>
            <input type="submit" formaction="/createCall3" value="Create Call 3!">
          </p>
          <p>
            <div style="font-weight: bold;">STEP 4a. Move Call</div>
            <div>Move Call for ACS Test Identity 2 to Initial Call</div>
            <input type="submit" disabled formaction="/moveParticipant2" value="Move Participant 2!">
          </p>
          <p>
            <div style="font-weight: bold;">STEP 4b. Move Call</div>
            <div>Move Call for ACS Test Identity 3 to Initial Call</div>
            <input type="submit" disabled formaction="/moveParticipant3" value="Move Participant 3!">
          </p>
          <p>
            <div style="font-weight: bold;">STEP 5. Terminate Calls</div>
            <div>Terminate all Calls created so far</div>
            <input type="submit" disabled formaction="/terminateCalls" value="Terminate Calls!">
          </p>
        </td>
        <td>
          <div id="callIdA-info">
            <div style="font-weight: bold;">Call Connection 1</div>
            <div>Call Connection Id: <span id="callIdA-text">Loading call Id...</span></div>
            <div>Caller Id: <span id="callerIdA-text">Loading caller Id...</span></div>
            <div>Callee Id: <span id="calleeIdA-text">Loading callee Id...</span></div>
          </div>
          <p id="callIdB-info">
            <div style="font-weight: bold;">Call Connection 2</div>
            <div>Call Connection Id: <span id="callIdB-text">Loading call Id...</span></div>
            <div>Caller Id: <span id="callerIdB-text">Loading caller Id...</span></div>
            <div>Callee Id: <span id="calleeIdB-text">Loading callee Id...</span></div>
          </p>
          <p id="callIdC-info">
            <div style="font-weight: bold;">Call Connection 3</div>
            <div>Call Connection Id: <span id="callIdC-text">Loading call Id...</span></div>
            <div>Caller Id: <span id="callerIdC-text">Loading caller Id...</span></div>
            <div>Callee Id: <span id="calleeIdC-text">Loading callee Id...</span></div>
          </p>
        </td>
      </tr>
    </table>
  </form>
  <script>
    let fetchInterval;
    let fetchCount = 0;

    function fetchCallData() {
      fetch('/call-data')
        .then(response => response.json())
        .then(data => {
          console.log('Call Connection Id 1:', data.callConnectionId1);
          console.log('Call Connection Id 2:', data.callConnectionId2);
          console.log('Call Connection Id 3:', data.callConnectionId3);
          if (data.callConnectionId1) document.getElementById('callIdA-text').innerText = `${data.callConnectionId1}`;
          if (data.callerId1) document.getElementById('callerIdA-text').innerText = `${data.callerId1}`;
          if (data.calleeId1) document.getElementById('calleeIdA-text').innerText = `${data.calleeId1}`;
          if (data.callConnectionId2) document.getElementById('callIdB-text').innerText = `${data.callConnectionId2}`;
          if (data.callerId2) document.getElementById('callerIdB-text').innerText = `${data.callerId2}`;
          if (data.calleeId2) document.getElementById('calleeIdB-text').innerText = `${data.calleeId2}`;
          if (data.callConnectionId3) document.getElementById('callIdC-text').innerText = `${data.callConnectionId3}`;
          if (data.callerId3) document.getElementById('callerIdC-text').innerText = `${data.callerId3}`;
          if (data.calleeId3) document.getElementById('calleeIdC-text').innerText = `${data.calleeId3}`;
          document.querySelector('input[formaction="/moveParticipant2"]').disabled = true;
          document.querySelector('input[formaction="/moveParticipant3"]').disabled = true;
          document.querySelector('input[formaction="/terminateCalls"]').disabled = true;
          if (data.callConnectionId1 && data.callConnectionId2) {
            document.querySelector('input[formaction="/moveParticipant2"]').disabled = false;
          }
          if (data.callConnectionId1 && data.callConnectionId3) {
            document.querySelector('input[formaction="/moveParticipant3"]').disabled = false;
          }
          if (data.callConnectionId1 || data.callConnectionId2 || data.callConnectionId3) {
            document.querySelector('input[formaction="/terminateCalls"]').disabled = false;
          }
        })
        .catch(error => {
          console.error('Error fetching user data:', error);
        });
    }

    function periodicFetchCallData() {
      fetchCount++;
      console.log(`Periodic fetch #${fetchCount}`);
      
      fetchCallData();
    }

    function startPeriodicFetch() {
      // Clear any existing interval
      if (fetchInterval) {
        clearInterval(fetchInterval);
      }
      // Reset counter
      fetchCount = 0;
      // Start fetching every 5 seconds
      fetchInterval = setInterval(periodicFetchCallData, 5000);
    }

    // Initial fetch on page load
    fetchCallData();

    // Add event listener to all form submit buttons
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('form');
      form.addEventListener('submit', (event) => {
        alert('Call submitted!');
      });
      setTimeout(() => {
        startPeriodicFetch();
      }, 1000);
    });
  </script>
</body>

</html>