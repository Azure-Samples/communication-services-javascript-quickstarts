<!DOCTYPE html>
<html lang="en">

<head>
  <title>Azure Communication Services Quickstart</title>
  <style>
    table {
      width: 100vw;
      table-layout: fixed;
      align-content: center;
    }
    th, td {
      vertical-align: top;
      padding: 10px;
      text-align: center;
    }
  </style>
</head>

<body>
  <h2 style="text-align: center;">Lobby Call Sample</h2>
  <form>
    <table>
      <tr>
        <th style="width: 50vw;">Call Connections</th>
        <th style="width: 50vw;">Call Details</th>
      </tr>
      <tr>
        <td>    
          <div>
            <div style="font-weight: bold;">STEP 0. Assign Environment Variables</div>
            <div>Configure environment variables in the .env file</div>
          </div>
          <p>
            <div style="font-weight: bold;">STEP 1. Configure Webhook</div>
            <div>Configure Event Grid webhook to point to /api/lobbyCallSupportEventHandler endpoint</div>
          </p>
          <p>
            <div style="font-weight: bold;">STEP 2. Configure a Lobby Call</div>
            <div>Make a Lobby call from Web Client App to ACS Generated ACS Identity manually. Once done, lobby call will be in a waiting state.</div>
          </p>
          <p>
            <div style="font-weight: bold;">STEP 3. Create User Call</div>
            <div>Create a Call for ACS Identity by clicking on this button and answer it manually from Web Client App</div>
            <input type="submit" formaction="/targetCallToAcsUser" value="Create Call!">
          </p>
          <p>
            <div style="font-weight: bold;">STEP 4. Answer User Call</div>
            <div>Once User call is connected, a message is played in Lobby asking to answer the User's call. You can accept it or reject it. Accept it manually from Web Client App. Now User is connected to Lobby call.</div>
          </p>
          <p>
            <div style="font-weight: bold;">STEP 5. Get Participants List in Lobby Call</div>
            <div>The list of all the participants in the Lobby call are automatically refreshed on the right panel.</div>
          </p>
          <p>
            <div style="font-weight: bold;">STEP 6. Terminate Calls</div>
            <div>Terminate all Calls created so far</div>
            <input type="submit" disabled formaction="/terminateCalls" value="Terminate Calls!">
          </p>
        </td>
        <td>
          <div id="participantInfo">
            <div style="font-weight: bold;">Lobby Call Info</div>
            <div>Participant Id 1: <span id="pIdA-text">Loading participant Id...</span></div>
            <div>Participant Id 2: <span id="pIdB-text">Loading participant Id...</span></div>
            <div>Participant Id 3: <span id="pIdC-text">Loading participant Id...</span></div>
          </div>
        </td>
      </tr>
    </table>
  </form>
  <script>
    let fetchInterval;
    let fetchCount = 0;

    function fetchCallData() {
      fetch('/call-data')
        .then(response => response.json())
        .then(data => {
          console.log('Participant Id 1:', data.participantId1);
          console.log('Participant Id 2:', data.participantId2);
          console.log('Participant Id 3:', data.participantId3);
          if (data.participantId1) document.getElementById('pIdA-text').innerText = `${data.participantId1}`;
          if (data.participantId2) document.getElementById('pIdB-text').innerText = `${data.participantId2}`;
          if (data.participantId3) document.getElementById('pIdC-text').innerText = `${data.participantId3}`;
          if (data.participantId1) {
            document.querySelector('input[formaction="/terminateCalls"]').disabled = false;
          } else {
            document.querySelector('input[formaction="/terminateCalls"]').disabled = true;
          }
        })
        .catch(error => {
          console.error('Error fetching user data:', error);
        });
    }

    function periodicFetchCallData() {
      fetchCount++;
      console.log(`Periodic fetch #${fetchCount}`);
      
      fetchCallData();
    }

    function startPeriodicFetch() {
      // Clear any existing interval
      if (fetchInterval) {
        clearInterval(fetchInterval);
      }
      // Reset counter
      fetchCount = 0;
      // Start fetching every 5 seconds
      fetchInterval = setInterval(periodicFetchCallData, 5000);
    }

    // Initial fetch on page load
    fetchCallData();

    // Add event listener to all form submit buttons
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('form');
      form.addEventListener('submit', (event) => {
        alert('Call submitted!');
      });
      setTimeout(() => {
        startPeriodicFetch();
      }, 1000);
    });
  </script>
</body>

</html>