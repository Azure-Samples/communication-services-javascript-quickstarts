# Azure VM Node.js Deployment Steps
# These should be done on the VM directly

# --- INSTALL PREREQUISITES (IIS) ---
1. Install IIS and necessary components like Management Console for IIS.
2.1. Create a download directory.
2.2. Download and Install URL Rewrite Module from below url.
"https://download.microsoft.com/download/1/2/8/128E2E22-C1B9-44A4-BE2A-5859ED1D4592/rewrite_amd64_en-US.msi"
2.3. Unlock IIS configuration sections.
PS Script
---------
Import-Module WebAdministration
try {
    # Unlock handlers section to allow configuration in web.config
    Set-WebConfiguration -Filter "/system.webServer/handlers" -PSPath "IIS:\" -Metadata "overrideMode" -Value "Allow"
    
    # Unlock modules section if needed
    Set-WebConfiguration -Filter "/system.webServer/modules" -PSPath "IIS:\" -Metadata "overrideMode" -Value "Allow"
    
    Write-Host "IIS configuration sections unlocked successfully."
} catch {
    Write-Warning "Could not unlock configuration sections: $($_.Exception.Message)"
}

# --- DOWNLOAD INSTALLERS ---
3. Download Node.js and iisnode installers to download directory created earlier.
# Directory already created in step 2.1
PS Script
---------
try {
    Invoke-WebRequest -Uri $NodeJsUrl -OutFile "$DownloadDir\$NodeJsMsi" -ErrorAction Stop
    Invoke-WebRequest -Uri $IisNodeUrl -OutFile "$DownloadDir\$IisNodeMsi" -ErrorAction Stop
    Write-Host "Download complete."
} catch {
    Write-Error "Failed to download installers: $($_.Exception.Message)"
    exit 1
}

# --- INSTALL NODE.JS AND IISNODE ---
4.1. Install Node.js (Silent).
PS Script
---------
try {
    # Install Node.js silently
    Start-Process msiexec -Wait -ArgumentList "/i `"$DownloadDir\$NodeJsMsi`" /qn ALLUSERS=1 ADDLOCAL=ALL" -ErrorAction Stop
    Write-Host "Node.js installed successfully."
} catch {
    Write-Error "Failed to install Node.js."
    exit 1
}

4.2. Install iisnode (Silent).
PS Script
---------
try {
    # Install iisnode silently
    Start-Process msiexec -Wait -ArgumentList "/i `"$DownloadDir\$IisNodeMsi`" /qn" -ErrorAction Stop
    Write-Host "iisnode installed successfully."
} catch {
    Write-Error "Failed to install iisnode."
    exit 1
}

# --- SETUP APPLICATION DIRECTORY AND FILES ---
5. Create application directory and deploying application files.
5.1. Create a source directory such as gcch-test-app below and copy all source files from the application directory into it.
5.2. Create an App directory in IIS directory similar to the source directory.
5.3. Copy the entire application to IIS directory
PS Script
---------
$SourceDir = "C:\Users\azureuser\gcch-test-app"
$AppDir = "C:\inetpub\wwwroot\gcch-test-app"
if (Test-Path $SourceDir) {
    Write-Host "Copying application files from $SourceDir to $AppDir..."
    Copy-Item "$SourceDir\*" -Destination $AppDir -Recurse -Force
    Write-Host "Application files copied successfully."
} else {
    Write-Host "Source directory not found..."
}

# --- INSTALL APPLICATION DEPENDENCIES ---
6.1. Open terminal (command) window from the App root directory.
6.2. Run command "npm install" 

# --- START APPLICATION & TEST LOCALLY ---
6.1. Start App by running command "npm run dev" 
6.2. Open browser and test the app by typing "http://localhost:8080" in address bar.

# --- CREATE ENVIRONMENT CONFIGURATION ---
7. Update environment configuration.
# Required: Azure Communication Services connection string
CONNECTION_STRING=your_acs_connection_string_here
# Required: Your ACS phone number (include country code, e.g., +1234567890)
ACS_RESOURCE_PHONE_NUMBER=your_acs_phone_number_here
# Required: Your callback URI (should match your VM's public endpoint)
CALLBACK_URI=https://your_vm_public_ip_or_domain
# Optional: Port (default is 8080, but will use IIS port when deployed)
PORT=8080
# Optional: Cognitive Services endpoint for call intelligence
COGNITIVE_SERVICES_ENDPOINT=your_cognitive_services_endpoint_here

# --- CONFIGURE EXTERNAL ACCESS ---
8. Configuring external access for the application.
8.1. Configuring Windows Firewall rules.
PS Script
---------
try {
    # Allow HTTP traffic (port 80)
    New-NetFirewallRule -DisplayName "Allow HTTP Inbound" -Direction Inbound -Protocol TCP -LocalPort 80 -Action Allow -ErrorAction SilentlyContinue
    Write-Host "HTTP (port 80) firewall rule added"
    
    # Allow HTTPS traffic (port 443)
    New-NetFirewallRule -DisplayName "Allow HTTPS Inbound" -Direction Inbound -Protocol TCP -LocalPort 443 -Action Allow -ErrorAction SilentlyContinue
    Write-Host "HTTPS (port 443) firewall rule added"
    
    # Allow port 8080 specifically
    New-NetFirewallRule -DisplayName "Allow Port 8080 Inbound" -Direction Inbound -Protocol TCP -LocalPort 8080 -Action Allow -ErrorAction SilentlyContinue
    Write-Host "Port 8080 firewall rule added"
    
    Write-Host "Windows Firewall configured successfully"
} catch {
    Write-Warning "Failed to configure Windows Firewall: $($_.Exception.Message)"
}

8.2. Configuring IIS to listen on additional ports.
PS Script
---------
try {
    Import-Module WebAdministration
    
    # Add binding for port 8080
    if (-not (Get-WebBinding -Name "Default Web Site" -Port 8080 -ErrorAction SilentlyContinue)) {
        New-WebBinding -Name "Default Web Site" -Protocol http -Port 8080
        Write-Host "Added IIS binding for port 8080"
    }
    
} catch {
    Write-Warning "Failed to configure IIS bindings: $($_.Exception.Message)"
}

8.3. Generating Azure CLI commands for NSG configuration.
PS Script
---------
$AzureCommands = @"
# Azure CLI commands to configure Network Security Group
# Run these commands in Azure Cloud Shell or local Azure CLI

# Replace 'your-resource-group' and 'your-nsg-name' with actual values
# Find these values in Azure Portal -> VM -> Networking

# Allow HTTP (port 80)
az network nsg rule create \
  --resource-group your-resource-group \
  --nsg-name your-nsg-name \
  --name Allow-HTTP-80 \
  --priority 1000 \
  --protocol Tcp \
  --destination-port-ranges 80 \
  --access Allow \
  --description "Allow HTTP traffic on port 80"

# Allow port 8080
az network nsg rule create \
  --resource-group your-resource-group \
  --nsg-name your-nsg-name \
  --name Allow-HTTP-8080 \
  --priority 1100 \
  --protocol Tcp \
  --destination-port-ranges 8080 \
  --access Allow \
  --description "Allow HTTP traffic on port 8080"

# Allow HTTPS (port 443) - Optional
az network nsg rule create \
  --resource-group your-resource-group \
  --nsg-name your-nsg-name \
  --name Allow-HTTPS-443 \
  --priority 1200 \
  --protocol Tcp \
  --destination-port-ranges 443 \
  --access Allow \
  --description "Allow HTTPS traffic on port 443"

# List current NSG rules to verify
az network nsg rule list \
  --resource-group your-resource-group \
  --nsg-name your-nsg-name \
  --output table
"@
$AzureCommands | Out-File "$AppDir\azure-nsg-config.sh" -Encoding UTF8
Write-Host "Azure CLI commands saved to: $AppDir\azure-nsg-config.sh"

[SUCCESS] DEPLOYMENT COMPLETE!

# --- CLEANUP ---
9. Clean up temporary folders & files.
9.1. Remove source directory.
9.2. Remove download folder.

# --- POST-DEPLOYMENT VERIFICATION & TROUBLESHOOTING ---
10. Perform post-deployment verification.
10.1. Check if IIS is running
10.2. Check if the application pool is running
10.3. Check if Node.js is properly installed.
10.4. Check if iisnode module is loaded.
10.5. Check IIS mappings

